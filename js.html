<script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
<script>
  const app = new Vue({
    el: '#app',
    vuetify: new Vuetify({
    }),
    data() {
      return {
        appName: 'Sora',
        drawer: false,
        ready: false,
        reveal: false,
        loading: true,
        disable: true,
        themeMode: true,
        answer: "",
        question: "",
        num: "",
        weakCount: 0,
        history: {},
        packs: null,
        flashcardData: null,
        flashcardName: null,
        flashcardExist: null,
        flashcardCreated: null,
        flashcardNameList: null,
        flashcardFileUrl: null,
        flashcardFileName: null,
        flashcardFileUrlDisabled: true,
      };
    },
    beforeCreate() {
      (async () => {
        this.packs = await googleScriptRun('getPacks');
        for (const pack of this.packs) {
          pack.decks = await googleScriptRun('getDecks', pack.id);
          for (const deck of pack.decks) {
            deck.parent = pack;
            deck.cards = await googleScriptRun('getCards', pack.id, deck.name);
          }
        }
        console.log(this.packs);
      })();
      // console.log(window.location);
      // console.log(copy);
      // setHistoryChangeHandler((event) => {
      //   const name = event.state.name;
      //   if (name !== null) {
      //     if (name !== this.flashcardName) {
      //       this.changeFlashcardList(name);
      //     } else {
      //       const card = event.state.card;
      //       if (card !== null) {
      //         this.changeFlashcard(card);
      //       }
      //     }
      //   }
      // });
    },
    created() {
      // this.loading = true;
      // existFlashcard((result) => {
      //   this.flashcardExist = result;
      //   this.loading = false;
      // }, (error) => {
      //   console.log(error);
      // });
    },
    mounted() {
      document.addEventListener('keydown', this.onKeyup);
    },
    beforeUnmount() {
      document.removeEventListener('keydown', this.onKeyup);
    },
    computed: {
    },
    watch: {
      'packs': {
        handler(val, old) {
          console.log('change packs!');
          console.log('new value:');
          console.log(val);
          console.log('old value:');
          console.log(old);
        },
      },
      'packs.decks': {
        handler(val, old) {
          console.log('change decks!');
          console.log('new value:');
          console.log(val);
          console.log('old value:');
          console.log(old);
        },
      },
      themeMode(value, old) {
        this.$vuetify.theme.dark = !value;
      },
      // flashcardCreated(value, old) {
      //   if (value) {
      //     this.loading = true;
      //     getFlashcardNameList((result) => {
      //       this.flashcardNameList = result;
      //       this.loading = false;
      //     }, (error) => {
      //       console.log(error);
      //     });
      //   }
      // },
      // flashcardExist(value, old) {
      //   if (value) {
      //     this.flashcardCreated = true;
      //     getFlashcardFileName((result) => {
      //       this.flashcardFileName = result;
      //     }, (error) => {
      //       console.log(error);
      //     });
      //     getFlashcardUrl((result) => {
      //       this.flashcardFileUrl = result;
      //       this.flashcardFileUrlDisabled = false;
      //     }, (error) => {
      //       console.log(error);
      //     });
      //   } else {
      //     this.loading = true;
      //     createUserFlashcard((result) => {
      //       this.flashcardExist = true;
      //       this.flashcardCreated = true;
      //       this.loading = false;
      //     }, (error) => {
      //       console.log(error);
      //     });
      //   }
      // },
      // flashcardNameList(value, old) {
      //   this.changeFlashcardList(this.flashcardNameList[0]);
      // },
    },
    methods: {
      onKeyup(event) {
        // console.log(event);
        switch (event.key) {
          case '0':
          case '1':
          case '2':
          case '3':
          case '4':
          case '5':
            this.onClickAssessment(parseInt(event.key));
            break;

          default:
            break;
        }
      },
      onClickAssessment(scale) {
        console.log(scale);
        this.increaseHistory(this.num);
        this.nextQuestion();
      },
      onClickDone(event) {
        this.increaseHistory(this.num);
        this.nextQuestion();
        // setItem(this.grade, trimHistory(this.history));
      },
      onClickClear(event) {
        this.decreaseHistory(this.num);
        this.nextQuestion();
        // setItem(this.grade, trimHistory(this.history));
      },
      onClickListItem(pack, deck) {
        // console.log(pack);
        // console.log(deck);
        // if (event !== this.flashcardName) {
        //   this.changeFlashcardList(event);
        // }
        this.changeFlashcardList(pack, deck);
        this.drawer = false;
      },
      flipCard() {
        this.reveal = !this.reveal;
      },
      changeFlashcardList(pack, deck) {
        this.loading = true;
        (async () => {
          deck.cards = await googleScriptRun('getCards', pack.id, deck.name);
          this.flashcardData = deck.cards;
          this.flashcardName = deck.name;
          this.nextQuestion();
          this.loading = false;
        })();
        console.log(pack);
        console.log(deck);
        // getFlashcardData(name, (result) => {
        //   this.flashcardData = result;
        //   this.flashcardName = name;
        //   // pushHistory({
        //   //   name: name,
        //   //   card: null,
        //   // }, {
        //   //   name: name,
        //   //   card: '',
        //   // }, '');
        //   this.nextQuestion();
        //   this.loading = false;
        // }, (error) => {
        //   console.log(error);
        // });
      },
      changeFlashcard(card) {
        this.loading = true;
        this.disable = true;
        this.turnFront(event);
        this.num = card[0];
        this.answer = card[1];
        this.question = card[2];
        this.disable = false;
        this.loading = false;
      },
      nextQuestion() {
        var q = null;
        if (this.weakCount === 0) {
          q = this.weakQuestion();
        }
        this.weakCount = (this.weakCount + 1) % 10;
        if (q === null || this.num === q[0]) {
          q = this.randomQuestion();
        }
        this.changeFlashcard(q);
        // pushHistory({
        //   name: this.flashcardName,
        //   card: q,
        // }, {
        //   name: this.flashcardName,
        //   card: this.num,
        // }, '');
      },
      weakQuestion() {
        var weak = null;
        for (var key in this.history) {
          if (this.history[key] < (this.history[weak] || 0)) {
            weak = key;
          }
        }
        if (weak !== null) {
          return this.flashcardData[weak - 1];
        }
        return null;
      },
      randomQuestion() {
        return this.flashcardData[getRandomInt(this.flashcardData.length)];
      },
      increaseHistory(num) {
        if (this.history[num] === undefined) {
          this.history[num] = 0;
        }
        this.history[num] += 1;
      },
      decreaseHistory(num) {
        if (this.history[num] === undefined) {
          this.history[num] = 0;
        }
        this.history[num] -= 1;
      },
      turnFront(event) {
        this.reveal = false;
        this.disable = false;
      },
      turnBack(event) {
        this.reveal = true;
        this.disable = false;
      },
    },
  });

  function createUserFlashcard(success, failure) {
    google.script.run
      .withSuccessHandler(success)
      .withFailureHandler(failure)
      .createUserFlashcard();
  }

  function existFlashcard(success, failure) {
    google.script.run
      .withSuccessHandler(success)
      .withFailureHandler(failure)
      .existUserFlashcard();
  }

  function getFlashcardNameList(success, failure) {
    google.script.run
      .withSuccessHandler(success)
      .withFailureHandler(failure)
      .getFlashcardNameList();
  }

  function getFlashcardData(name, success, failure) {
    google.script.run
      .withSuccessHandler(success)
      .withFailureHandler(failure)
      .getFlashcardData(name);
  }

  function getFlashcardFileName(success, failure) {
    google.script.run
      .withSuccessHandler(success)
      .withFailureHandler(failure)
      .getFlashcardFileName();
  }

  function getFlashcardUrl(success, failure) {
    google.script.run
      .withSuccessHandler(success)
      .withFailureHandler(failure)
      .getFlashcardUrl();
  }

  function pushHistory(state, params, hash) {
    google.script.history
      .push(state, params, hash);
  }

  function replaceHistory(state, params, hash) {
    google.script.history
      .replace(state, params, hash);
  }

  function setHistoryChangeHandler(handler) {
    google.script.history
      .setChangeHandler(handler);
  }

  function googleScriptRun(name, ...args) {
    return new Promise(function (resolve, reject) {
      google.script.run
        .withSuccessHandler(function (...e) {
          resolve(...e);
        }).withFailureHandler(function (...e) {
          reject(...e);
        })[name](...args);
    });
  }

  function getRandomInt(max) {
    return Math.floor(Math.random() * max);
  }
</script>