<script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
<script>
  const app = new Vue({
    el: '#app',
    vuetify: new Vuetify({
    }),
    data() {
      return {
        appName: 'Sora',
        drawer: false,
        ready: false,
        reveal: false,
        loading: true,
        disable: true,
        themeMode: true,
        answer: "",
        question: "",
        num: "",
        weakCount: 0,
        history: {},
        packs: null,
        current: {
          pack: null,
          deck: null,
          card: null,
        },
        flashcardData: null,
        flashcardName: null,
        flashcardExist: null,
        flashcardCreated: null,
        flashcardNameList: null,
        flashcardFileUrl: null,
        flashcardFileName: null,
        flashcardFileUrlDisabled: true,
      };
    },
    beforeCreate() {
      google.script.history.setChangeHandler((event) => {
        // event.location.parameters;
        // const name = event.state.name;
        // if (name !== null) {
        //   if (name !== this.flashcardName) {
        //     this.changeFlashcardList(name);
        //   } else {
        //     const card = event.state.card;
        //     if (card !== null) {
        //       this.changeFlashcard(card);
        //     }
        //   }
        // }
      });
      (async () => {
        this.packs = await googleScriptRun('getPacks');
        if (this.packs.length > 0) {
          this.current.pack = this.packs[0];
        }
      })();
    },
    created() {
    },
    mounted() {
      document.addEventListener('keydown', this.onKeyup);
    },
    beforeUnmount() {
      document.removeEventListener('keydown', this.onKeyup);
    },
    computed: {
      enableCurrentPackUrl() {
        if (this.current.pack !== null) {
          return true;
        }
        return false;
      },
      currentPackUrl() {
        if (this.enableCurrentPackUrl) {
          return this.current.pack.url;
        }
        return '';
      },
    },
    watch: {
      // 'current': {
      //   handler(val, old) {
      //     console.log('change current!');
      //     console.log('new value:');
      //     console.log(val);
      //     console.log('old value:');
      //     console.log(old);
      //   },
      // },
      'current.pack': {
        handler(val, old) {
          (async () => {
            val.decks = await googleScriptRun('getDecks', val.id);
            if (val.decks.length > 0) {
              this.current.deck = val.decks[0];
            }
            // console.log(this.current);
          })();
          // console.log('change pack!');
          // console.log('new value:');
          // console.log(val);
          // console.log('old value:');
          // console.log(old);
        },
      },
      'current.deck': {
        handler(val, old) {
          (async () => {
            val.cards = await googleScriptRun('getCards', this.current.pack.parent, val.name);
            if (val.cards.length > 0) {
              this.current.card = val.cards[0];
            }
            // console.log(this.current);
          })();
          // console.log('change deck!');
          // console.log('new value:');
          // console.log(val);
          // console.log('old value:');
          // console.log(old);
        },
      },
      'current.card': {
        handler(val, old) {
          this.changeCard(val);
          // console.log('change card!');
          // console.log('new value:');
          // console.log(val);
          // console.log('old value:');
          // console.log(old);
        },
      },
      themeMode(value, old) {
        this.$vuetify.theme.dark = !value;
      },
    },
    methods: {
      onKeyup(event) {
        // console.log(event);
        switch (event.key) {
          case '0':
          case '1':
          case '2':
          case '3':
          case '4':
          case '5':
            this.onClickAssessment(parseInt(event.key));
            break;

          default:
            break;
        }
      },
      onClickAssessment(scale) {
        console.log(scale);
        this.increaseHistory(this.num);
        this.nextQuestion();
      },
      // onClickDone(event) {
      //   this.increaseHistory(this.num);
      //   this.nextQuestion();
      //   // setItem(this.grade, trimHistory(this.history));
      // },
      // onClickClear(event) {
      //   this.decreaseHistory(this.num);
      //   this.nextQuestion();
      //   // setItem(this.grade, trimHistory(this.history));
      // },
      onClickListItem(pack, deck) {
        this.changeDeck(pack, deck);
        this.drawer = false;
      },
      onClickTurn(event) {
        this.flipCard();
      },
      changeDeck(pack, deck) {
        this.loading = true;
        (async () => {
          deck.cards = await googleScriptRun('getCards', pack.id, deck.name);
          // this.flashcardData = deck.cards;
          // this.flashcardName = deck.name;
          this.nextQuestion();
          this.loading = false;
        })();
      },
      changeCard(card) {
        this.loading = true;
        this.disable = true;
        this.turnFront();
        this.num = card.id;
        this.answer = card.back;
        this.question = card.front;
        this.disable = false;
        this.loading = false;
      },
      nextQuestion() {
        var card = null;
        if (this.weakCount === 0) {
          card = this.weakCard();
        }
        this.weakCount = (this.weakCount + 1) % 10;
        if (card === null || this.num === card[0]) {
          card = this.randomCard();
        }
        this.changeCard(card);
        // pushHistory({
        //   name: this.flashcardName,
        //   card: q,
        // }, {
        //   name: this.flashcardName,
        //   card: this.num,
        // }, '');
      },
      weakCard() {
        var weak = null;
        for (var key in this.history) {
          if (this.history[key] < (this.history[weak] || 0)) {
            weak = key;
          }
        }
        if (weak !== null) {
          return this.flashcardData[weak - 1];
        }
        return null;
      },
      randomCard() {
        return this.flashcardData[getRandomInt(this.flashcardData.length)];
      },
      increaseHistory(num) {
        if (this.history[num] === undefined) {
          this.history[num] = 0;
        }
        this.history[num] += 1;
      },
      decreaseHistory(num) {
        if (this.history[num] === undefined) {
          this.history[num] = 0;
        }
        this.history[num] -= 1;
      },
      flipCard() {
        this.reveal = !this.reveal;
      },
      // turnFront(event) {
      //   this.reveal = false;
      //   this.disable = false;
      // },
      // turnBack(event) {
      //   this.reveal = true;
      //   this.disable = false;
      // },
    },
  });

  function pushHistory(state, params, hash) {
    google.script.history
      .push(state, params, hash);
  }

  function replaceHistory(state, params, hash) {
    google.script.history
      .replace(state, params, hash);
  }

  function setHistoryChangeHandler(handler) {
    google.script.history
      .setChangeHandler(handler);
  }

  function googleScriptRun(name, ...args) {
    return new Promise(function (resolve, reject) {
      google.script.run
        .withSuccessHandler(function (...e) {
          resolve(...e);
        }).withFailureHandler(function (...e) {
          reject(...e);
        })[name](...args);
    });
  }

  function getRandomInt(max) {
    return Math.floor(Math.random() * max);
  }
</script>